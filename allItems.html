<html>

<head>
  <title>Liste der intelligenten Geräte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <script src="js/bootstrap.min.js"></script>
  <link href="css/menu.css" rel="stylesheet">
  <script src="js/device.js"></script>
  <script src="js/interface.js"></script>
  <script src="js/markers.js"></script>

</head>

<body style="font-family: arial;"> 
<div id="headline">
    
    <div class="buttonDiv">
        <button class="backbutton" onclick="location.href='index.html'"> &lt&lt</button> 
    </div>
    <p>Liste aller bekannten intelligente Geräte des Systems. Klicke auf sie, um ihnen eine spezifische ID zu geben<br/> </p> 
</div>

<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
        <div>
            <p id="arucoText">ID: </p>
            <input id="arucoID" type="number" name="quantity" min="0" max="1023" onchange="checkID(false)">
            <p id="warningText"> </p>
        </div>
        
        <canvas id="arucoCode"></canvas>
        <p id="infoText">Der dargestellte Marker kann abgespeichert und ausgedruckt werden, um ihn an das entsprechende Geräte anzubringen. Falls die Größe nicht den Vorstellungen entspricht, kann auf folgender Seite ein beliebig großer Marker erstellt werden:</p>
        <a href="http://terpconnect.umd.edu/~jwelsh12/enes100/markergen.html" target="_blank"> Marker Erstellen</a>  
        
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" onclick="checkID(true)">Bestätigen</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Schließen</button>
      </div>
    </div>

  </div>
</div>

<script>
  var arucoListe = new Array, check = false;
      
     window.onload = function(){
        var devices = getAllDevices();
        for(var i = 0 ; i<devices.length ; i++){
            createItem(devices[i]);
            arucoListe[i] = devices[i].arucoid;
        }

     } 

    function createItem(device){
        //console.log(device);

        var div = document.createElement("div");
        div.setAttribute("class", "square bg");
        div.setAttribute("id", device.arucoid);
        div.setAttribute("style", "background-image: url('img/background.jpg'" );
        div.setAttribute("onclick", "openModal(this, '"+device.name+"' , '"+device.id +"')");

        var div2 = document.createElement("div");
        div2.setAttribute("class", "content");

        var div3 = document.createElement("div");
        div3.setAttribute("class", "table");

        var div4 = document.createElement("div");
        div4.setAttribute("class", "table-cell");
        if(device.arucoid !=  ""){
            div4.innerHTML = device.name +  '<br>' +'ID: ' + device.arucoid;
        }else{
            div4.innerHTML = device.name +  '<br>' +'Keine ID hinterlegt';
        }

        div3.appendChild(div4);
        div2.appendChild(div3);
        div.appendChild(div2);
        document.body.appendChild(div);

    }

    function openModal(item, name, itemid){
        $('.modal-title').text(name);

        drawArucoMarker(item.id);   
        $('#myModal').attr('arucoid',item.id);
        $('#myModal').attr('itemid',itemid);
        $('#myModal').modal('toggle');
    }

    function drawArucoMarker(itemId){

        var canvas = document.getElementById('arucoCode');
        canvas.width = $('.square').width();
        canvas.height = $('.square').width();

        if(itemId != ""){
            canvasBuffer  = makeMarker(itemId , $('.square').width()-30,$('.square').width()-30);
            var ctx = canvas.getContext('2d');
            ctx.drawImage(canvasBuffer, 0, 0);
            $('#arucoID').val(itemId);
            
        } else{
            $('#arucoID').val('');
        }   
    }

    function checkID(type){
        var oldid = $('#myModal').attr('arucoid');
        
        if($('#arucoID').val() > 1023){
            $('#arucoID').val(oldid);
            $('#warningText').text('WARNUNG: 1023 ist die maximale ID');
            $("#warningText").show();
            setTimeout(function() { $("#warningText").hide(); }, 3000);
            check = false;
        }else if($.inArray($('#arucoID').val(), arucoListe) != -1){
            if(!type){
                $('#warningText').text('WARNUNG: ID ' + $('#arucoID').val()+' ist bereits vergeben');
            }else{
                $('#warningText').text('ID ist bereits vergeben oder über 1023!');
            }
            $('#arucoID').val(oldid);
            $("#warningText").show();
            setTimeout(function() { $("#warningText").hide(); }, 3000);
            check = false;
        } else{
            check = true;
        }

        drawArucoMarker($('#arucoID').val());
       
        if(type && check){
            changeArucoMarker();
        }
    }

    function changeArucoMarker(){
        var itemid = $('#myModal').attr('itemid');
        var newid = $('#arucoID').val();
        
        updateData(newid, itemid , 'arucoid');

        //location.reload();
    }

  </script>

</body>
  
</html>