<html>

<head>
  <title>Augmented Reality Marker Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes"/>

  <link href="css/bootstrap.min.css" rel="stylesheet">

  <script type="text/javascript" src="libs/polyfill.js"></script> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="js/cv.js"></script> 
  <script type="text/javascript" src="js/interface.js"></script> 
  <script type="text/javascript" src="js/aruco.js"></script> 
  <script type="text/javascript" src="js/device.js"></script> 
  <script type="text/javascript" src="js/jscolor.js"></script> 
	<script src="js/bootstrap.min.js"></script>
  <link href="css/menu.css" rel="stylesheet">

  <script>
    var video, track, canvas, context, imageData, detector, items, rectPos = new Array, index;

    window.onload = function(){
    	
    	items = new Array(1024);
    	var devices = getAllDevices();
    	
    	for (var i =  0; i < devices.length; i++) {
    		//console.log(i, devices[i].arucoid);
    		if(devices[i].arucoid != ""){
    			items[devices[i].arucoid] = devices[i];
    		}
    	}
    	$('#canvas').click(function(e) {
        var scaling = 900 / (window.innerWidth *0.9);
    	var x = e.offsetX * scaling,
        	y = e.offsetY * scaling;

          
          //console.log(x, y , 900 / (window.innerWidth *0.9), rectPos);

        	for(var j=0;j<rectPos.length;j++) {
        		if(x > rectPos[j][0]
        		&& x < rectPos[j][0] + rectPos[j][2]
        		&& y > rectPos[j][1]
        		&& y < rectPos[j][1] + rectPos[j][3]) {

              switch(rectPos[j][4]) {
                case 'An':
                  if (items[rectPos[j][5]].state == 'on') {
                    alert('Gerät: ' + items[rectPos[j][5]].name + ' ist bereits ' + rectPos[j][4]);
                  }else{
                    updateData('on', items[rectPos[j][5]].id, 'state')
                    items[rectPos[j][5]].state = 'on';
                    alert( items[rectPos[j][5]].name + ' wurde ' + rectPos[j][4] + ' geschaltet' );
                  }
                  break;
                case 'Aus':
                  if (items[rectPos[j][5]].state == 'off') {
                    alert('Gerät: ' + items[rectPos[j][5]].name + ' ist bereits ' + rectPos[j][4]);
                  }else{
                    updateData('off', items[rectPos[j][5]].id, 'state')
                    items[rectPos[j][5]].state = 'off';
                    alert( items[rectPos[j][5]].name + ' wurde ' + rectPos[j][4] + ' geschaltet' );
                  }
                  break;
                case 'Dimmen':
                  $('#myModal').modal('toggle');
                  break;
                  
                default:
                  alert('Aktion3: ' + rectPos[j][4] + ' von Geräte mit der ID: ' + rectPos[j][5] + items[rectPos[j][5]].name);
              }
            		
        		}
    		}
    
    	});
    	
    }
  
    function startStream(){
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      canvas.style.visibility = "visible" ;
      context = canvas.getContext("2d");
    
      canvas.width = parseInt(canvas.width);
      canvas.height = parseInt(canvas.height);
      
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

      if (navigator.getUserMedia){
        
        function successCallback(stream){
          if (window.URL) {
            video.src = window.URL.createObjectURL(stream);
            track = stream.getTracks()[0];;
            //console.log(stream, track);
          } else if (video.mozSrcObject !== undefined) {
            video.mozSrcObject = stream;
            track = stream.getTracks()[0];;
            //console.log(stream, track);
          } else {
            video.src = stream;
            track = stream.getTracks()[0];
            //console.log(stream, track);
          }
        }
        
        function errorCallback(error){
        	console.log(error);
        }


		/*if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
  			console.log("enumerateDevices() not supported.");
  			return;
		 }
		// List cameras and microphones.

		navigator.mediaDevices.enumerateDevices().then(function(devices) {
    		devices.forEach(function(device) {
      			console.log(device.kind + ": " + device.label +
        		" id = " + device.deviceId);
    		});
  		}).catch(function(err) {
    		console.log(err.name + ": " + error.message);
  		});*/

        
        navigator.getUserMedia({ video: {facingMode: "environment"} }, successCallback, errorCallback);
        
        detector = new AR.Detector();
    
        requestAnimationFrame(tick);
      }
    }

    function stopStream(){
      track.stop();
      document.getElementById("canvas").style.visibility = "hidden" ;

    }
    
    
    function tick(){
      requestAnimationFrame(tick);
      
      if (video.readyState === video.HAVE_ENOUGH_DATA){
        snapshot();

        var markers = detector.detect(imageData);

        drawCorners(markers);
        drawIdOrName(markers);
        
      }
    }

    function snapshot(){
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    }
          
    function drawCorners(markers){
      var corners, corner, i, j;
    
      context.lineWidth = 3;

      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        context.strokeStyle = "red";
        context.beginPath();
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          context.moveTo(corner.x, corner.y);
          corner = corners[(j + 1) % corners.length];
          context.lineTo(corner.x, corner.y);
        }

        context.stroke();
        context.closePath();
        
        context.strokeStyle = "green";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
      }
    }

    function drawIdOrName(markers){
      var corners, corner, xMin, yMin, xMax, yMax, i, j, k;
      index = 0;
      rectPos = [];
      
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        xMin = Infinity;
        yMin = Infinity;
        xMax = 0;
        yMax = 0;
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          
          xMin = Math.min(xMin, corner.x);
          yMin = Math.min(yMin, corner.y);

          xMax = Math.max(xMax, corner.x);
          yMax = Math.max(yMax, corner.y);
        }

        //console.log(items[markers[i].id]);
        if( typeof items[markers[i].id] != 'undefined'){

        	var text = items[markers[i].id].name;
        	if(window.innerWidth <= 600){
            context.font = "30px Verdana";
          }else{
            context.font = "20px Verdana";
          }	
			    var txtHeight = parseInt(context.font);
          
        	drawRect(text, xMin, yMin);
        	
        	for(k = 0; k !== items[markers[i].id].functions.length; k++ ){
        		//console.log(items[markers[i].id].functions[k]);
        		text = items[markers[i].id].functions[k];
        		drawRect(text, xMax, ((k+1) * (txtHeight+10) +  yMin) , 1, markers[i].id);
        	}

        }else{
        	context.font = "10px Verdana";
        	context.fillStyle = "red";
      		context.lineWidth = 1;
        	context.fillText(markers[i].id, xMin, yMin - 5 )
        }
      }
    }

    function drawRect(text, x, y, type, id){
    	var type = type || 0;
		  var length = text.length;

		  var txtHeight = parseInt(context.font);

		  context.beginPath();
    	context.rect(x - 3, y - txtHeight + 2 , context.measureText(text).width + 10, txtHeight + 3 );

    	if(type == 0){
      	context.fillStyle = '#858585';
     	  context.fill();
      	context.lineWidth = 1;
      	context.strokeStyle = 'black';
      	context.stroke();	

	  	  context.fillStyle = '#E8E8E8';
        context.fillText(text, x, y)
		  }else{ 


		    rectPos[index] = [x - 3, y - txtHeight + 2 , context.measureText(text).width + 10, txtHeight + 3 , text , id ];
		    index++;
		    //console.log(rectPos);

      	context.fillStyle = 'white';
      	context.shadowColor = 'black';
      	context.shadowBlur = 15;
      	context.shadowOffsetX = 7;
      	context.shadowOffsetY = 7;
      
     	  context.fill();
     	  context.shadowColor = "transparent";
      	context.lineWidth = 1;
      	context.strokeStyle = 'black';
      	context.stroke();	

	  	  context.fillStyle = '#595959';
        context.fillText(text, x, y)
		  }
    }

    function update(jscolor) {
      document.getElementById('rect').style.backgroundColor = '#' + jscolor
    }



    //window.onload = onLoad;
  </script>

</head>

<body style="font-family: arial;">
  <div id="headline">
    <div class="buttonDiv">
      <button class="backbutton" onclick="location.href='index.html'"> &lt&lt</button> 
    </div>
    
    <p >Steuerung per Augmented Reality:<br/></p> 
  </div>
  <div id="streamButtondiv">
    <button class="arStartButtons" onclick="startStream()">Starte Erkennung</button>
    <button class="arStartButtons" onclick="stopStream()">Beende Erkennung</button>
  </div>
  
  <center>
  <video id="video" autoplay="true" style="display:none;"></video>
  <canvas id="canvas" width="900" height="500" "></canvas>
  </center>


  <div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
      <input value="ffcc00" class="jscolor {onFineChange:'update(this)', width:243, height:150, position:'right',
    borderColor:'#FFF', insetColor:'#FFF', backgroundColor:'#666'}">
        

        <p id="rect" style="border:1px solid gray; width:161px; height:100px;">
        
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" onclick="changeArucoMarker()" data-dismiss="modal">Bestätigen</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Schließen</button>
      </div>
    </div>

  </div>
</div>


</body>
  
</html>